<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Scape</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <header class="main-header">
        <h1>Space Scape</h1>
    </header>

    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
        <div id="message-overlay"></div>
        <div id="win-overlay">
            <h2>Vitória!</h2>
            <p>Você chegou ao destino!</p>
            <button onclick="increaseDifficultyAndReset()">Próximo Nível</button>
        </div>
    </div>

    <div class="controls-container">
        <div class="stats-and-controls">
            <div class="stats">
                <span class="stat-label">Velocidade: <span class="stat-value" id="speedValue">0.00</span> <span class="stat-unit">u/s</span></span>
                <span class="stat-label">Distância ao Alvo: <span class="stat-value" id="distanceValue">0.00</span> <span class="stat-unit">u</span></span>
                <span class="stat-label">Combustível: <span class="stat-value" id="fuelValue">100</span> <span class="stat-unit">L</span></span>
            </div>
            <button onclick="resetGame()">Reiniciar</button>
            <div class="control-group">
                <label for="planetCount">Astros:</label>
                <input type="number" id="planetCount" min="1" max="100" value="1"  onfocusout="updatePlanetCount(this.value)">
            </div>
        </div>
        
        <div id="key-config-container">
            <p>Controles de Teclado:</p>
            <div class="key-input">
                <label for="key-forward">Avançar</label>
                <input type="text" id="key-forward" value="ArrowUp" readonly>
            </div>
            <div class="key-input">
                <label for="key-backward">Retroceder</label>
                <input type="text" id="key-backward" value="ArrowDown" readonly>
            </div>
            <div class="key-input">
                <label for="key-left">Virar Esq.</label>
                <input type="text" id="key-left" value="ArrowLeft" readonly>
            </div>
            <div class="key-input">
                <label for="key-right">Virar Dir.</label>
                <input type="text" id="key-right" value="ArrowRight" readonly>
            </div>
        </div>
    </div>
    <script src="assets/js/touch-connect.js"></script>
    <script>
    // Variável para armazenar a última tecla "pressionada"
    let lastKeyPressed = null;

    const config = {
        mode: 'one-point',
        screenWidth: window.innerWidth,
        screenHeight: window.innerHeight,
        referencePoints: [
            { x: window.innerWidth / 2, y: window.innerHeight / 2 }
        ]
    };

    const touchHandler = new TouchConnect(config);

    // Listener para o evento touchmove (para "pressionar" a tecla)
    touchHandler.onMove((results, event) => {
        if (results.length > 0) {
            const [dx, dy] = results[0];
            // Calcula ângulo em graus a partir do centro
            const angle = Math.atan2(-dy, dx) * 180 / Math.PI;
            let key = null;
            if (angle >= 45 && angle < 135) key = 'ArrowUp';
            else if (angle >= -45 && angle < 45) key = 'ArrowRight';
            else if (angle >= -135 && angle < -45) key = 'ArrowDown';
            else key = 'ArrowLeft';

            if (lastKeyPressed !== key) {
                // Se mudou de região, solta a anterior
                if (lastKeyPressed) {
                    dispatchEvent(lastKeyPressed, 'keyup');
                }
                dispatchEvent(key, 'keydown');
                lastKeyPressed = key;
            }
        }
    });

    // Listener para o evento touchend/touchcancel (para "soltar" a tecla)
    function releaseKey() {
        if (lastKeyPressed) {
            dispatchEvent(lastKeyPressed, 'keyup');
            lastKeyPressed = null;
        }
    }
    document.body.addEventListener('touchend', releaseKey);
    document.body.addEventListener('touchcancel', releaseKey);

    /**
     * Função auxiliar para disparar o evento de teclado.
     * @param {string} keyName - O nome da tecla, por exemplo, 'ArrowUp'.
     * @param {string} eventType - 'keydown' ou 'keyup'.
     */
    function dispatchEvent(keyName, eventType) {
        const keyboardEvent = new KeyboardEvent(eventType, {
            key: keyName,
            code: keyName,
            bubbles: true,
            cancelable: true
        });
        document.body.dispatchEvent(keyboardEvent);
    }
    </script>
    <script src="assets/js/script.js"></script>
    <script>
        // Detecta se é mobile (tela <= 768px ou userAgent)
        function isMobileDevice() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        let minR, maxR, minDist;
        if (isMobileDevice()) {
            minR = 10;
            maxR = 30;
            minDist = 150;
            rocketSize = 6; // Tamanho do foguete menor para mobile
            colisionThreshold = 100; // Limite de colisão menor para mobile
        } else {
            minR = 20;
            maxR = 90;
            minDist = 200;
            rocketSize = 10; // Tamanho do foguete maior para desktop
            colisionThreshold = 150; // Limite de colisão maior para desktop
        }
        init(minR, maxR, minDist, rocketSize, colisionThreshold);
    </script>
</body>
</html>